pipeline {
    agent any

    environment {
        DOCKER_USER = 'tnagasai'
    }

    stages {
        stage('Deploy to Kubernetes Master') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-creds',
                                                  usernameVariable: 'DOCKER_USERNAME_VAR',
                                                  passwordVariable: 'DOCKER_PASSWORD_VAR')]) {
                    sshagent(['test']) {
                        sh """
                        ssh -o StrictHostKeyChecking=no ubuntu@13.232.221.83 <<'EOF_REMOTE_SCRIPT'
                            export DOCKER_USERNAME="${DOCKER_USERNAME_VAR}"
                            export DOCKER_PASSWORD="${DOCKER_PASSWORD_VAR}"

                            rm -rf test-project
                            git clone https://github.com/Tatanagasai20/test-project.git
                            cd test-project/node-app/node-app

                            docker build -t nodeapp-image .
                            docker tag nodeapp-image "\$DOCKER_USERNAME"/nodeapp-image:latest

                            echo "\$DOCKER_PASSWORD" | docker login -u "\$DOCKER_USERNAME" --password-stdin

                            docker push "\$DOCKER_USERNAME"/nodeapp-image:latest

                            kubectl apply -f deployment.yaml --validate=false
                            kubectl apply -f service.yaml --validate=false
                        EOF_REMOTE_SCRIPT  // <--- ENSURE NO LEADING WHITESPACE HERE
                        """
                    }
                }
            }
        }
    }
}
